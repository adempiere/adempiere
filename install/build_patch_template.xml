<!-- ================================================ -->
<!-- Adempiere Patch Builder                            -->
<!-- ================================================ -->
<!-- $Header: /cvs/adempiere/utils_dev/build_patch_template.xml -->
<project name="adempiere" default="complete" basedir="../">
	
	<description>
    	This buildfile is used to build minor version install patches for the Adempiere system.
		It includes patches.jar and all other supporting files.  The patch is designed to be
		extracted over the ADEMPIERE_HOME directory, replacing existing files with new ones.
		Patches should be inclusive of all previous patches, so only the latest patch needs 
		to be installed.
		
		To use the template, copy the file giving it a name specific to the patch and edit it to 
		include the necessary files for the patch.  Run the target "complete" to build the patch 
		and install it.  The target "dist" will generate the patch archives without the install. 
	</description>
	
	<!-- set global properties for this build -->
	<!--<property environment="env"/>-->
  	<import file="../utils_dev/properties.xml"/>
	<property name="base.dir" value="."/>
	<property name="src" value="src"/>
	<property name="patch.dir" value="install/patch"/>
	
	<!-- Set the package name.  This will be used to name the archives.
		 This should be in the form patches_[bas_version]_[branch]_[date] 
	-->
	<property name="base_version" value="380LTS"/>
	<property name="patch_branch" value="hotfix#002"/>
	<property name="patch_date" value="20150501"/>
	<property name="patch.name" value="patches_${base_version}_${patch_branch}_${patch_date}"/>
	
	<target name="clean">
		<!-- Delete the ${patch.dir} directory tree -->
		<delete dir="${patch.dir}"/>
	</target>

	<target name="init" description="initialization target" depends="clean">
		<echo message="=========== Build Adempiere Patch - ${env.ENCODING}"/>
		<!-- Create the time stamp -->
		<tstamp/>
	    <!-- create the package directory structure used by compile -->
	    <mkdir dir="${patch.dir}"/>
	    <mkdir dir="${patch.dir}/jar"/>
	    <mkdir dir="${patch.dir}/jar/src"/>
	</target>
	
	<!-- ======================================================= -->
	<!-- Create patches.jar                                    -->
	<!-- ======================================================= -->
	<target name="build_patches.jar" depends="init">
		<!-- This target builds the patches.jar file.  It copies all required class 
			 files to the patches/jar/src/patches directory. The list of files is 
			 generated by running git diff and then determining all the class 
			 files from the output. The files included below are for example.     
		 -->
		<mkdir dir="${patch.dir}/jar/src/patches"/>
		
		<copy todir="${patch.dir}/jar/src/patches">
		  <fileset dir="${base.dir}/base/build">
		  	<include name="org/compiere/model/I_M_Locator.class"/>
		  	<include name="org/compiere/model/MLocator.class"/>
		  	<include name="org/compiere/model/MLocatorLookup.class"/>
		  	<include name="org/compiere/model/X_M_Locator.class"/>
		  </fileset>
		  <fileset dir="${base.dir}/client/build">
		  	<include name="org/compiere/grid/ed/VLocatorDialog.class"/>
		  </fileset>
		</copy>

		
		<!-- put everything into the patches.jar file -->
		<jar
		  jarfile="${patch.dir}/jar/patches.jar"
		  index="yes"
		  duplicate="preserve">
		  <fileset dir="${patch.dir}/jar/src/patches"/>
				
		  <manifest>
			<attribute name="Specification-Title" value="Patches"/>
			<attribute name="Specification-Version" value="ADempiere ${base_version} ${patch_branch} ${patch_date}"/>
			<attribute name="Specification-Vendor" value="Adempiere.org"/>
			<attribute name="Implementation-Title" value="ADempiere ${base_version} ${patch_branch} ${patch_date}"/>
			<attribute name="Implementation-Version" value="${base_version} ${patch_branch} ${patch_date}"/>
			<attribute name="Implementation-Vendor" value="${env.ADEMPIERE_VENDOR}"/>
			<attribute name="Implementation-URL" value="http://www.adempiere.org"/>
		  </manifest>
		</jar>

		<copy todir="${base.dir}/install/patch/Adempiere/lib">
		  <fileset dir="${patch.dir}/jar">
		  	<include name="patches.jar"/>
		  </fileset>
		</copy>

	</target>

	<!-- ======================================================= -->
	<!-- Create zkpatches.jar                                    -->
	<!-- ======================================================= -->
	<target name="build_zkpatches.jar" depends="init">
		<!-- This target builds the zkpatches.jar file.  It copies all required class 
			 files to the patches/jar/src/zkpatches directory. The list of files is 
			 generated by running git diff and then determining all the class 
			 files from the output. The files included below are for example. Add the 
			 .class and resource files to include in the zkpatch.jar. The top 
			 directory in the .jar should be WEB-INF 
		 -->
		<mkdir dir="${patch.dir}/jar/src/zkpatches"/>

		<copy todir="${patch.dir}/jar/src/zkpatches">
		  <fileset dir="${base.dir}/zkwebui/">
		  	<include name="WEB-INF/classes/org/adempiere/webui/window/WLocatorDialog.class"/>
		  </fileset>			
		</copy>

		
		<!-- put everything into the patches.jar file -->
		<jar
		  jarfile="${patch.dir}/jar/zkpatches.jar"
		  index="yes"
		  duplicate="preserve">
		  <fileset dir="${patch.dir}/jar/src/zkpatches"/>
				
		  <manifest>
			<attribute name="Specification-Title" value="ZK Patches"/>
			<attribute name="Specification-Version" value="ADempiere ${base_version} ${patch_branch} ${patch_date}"/>
			<attribute name="Specification-Vendor" value="Adempiere.org"/>
			<attribute name="Implementation-Title" value="ADempiere ${base_version} ${patch_branch} ${patch_date}"/>
			<attribute name="Implementation-Version" value="${base_version} ${patch_branch} ${patch_date}"/>
			<attribute name="Implementation-Vendor" value="${env.ADEMPIERE_VENDOR}"/>
			<attribute name="Implementation-URL" value="http://www.adempiere.org"/>
		  </manifest>
		</jar>

		<copy todir="${base.dir}/install/patch/Adempiere/lib">
		  <fileset dir="${patch.dir}/jar">
		  	<include name="zkpatches.jar"/>
		  </fileset>
		</copy>

	</target>

	  <!-- ======================================================= -->
	  <!-- Create Patch Distribution Archives                      -->
	  <!-- ======================================================= -->
	  <target name="dist" depends="build_patches.jar, build_zkpatches.jar">
		<!-- This target builds the zip and tar archives file. It will include the
			 patches.jar, zkpatches.jar.  Directories and files that also need to 
			 be added to the archives should be copied into the ${patch.dir}/Adempiere/
			 directory using the same folder structure as the Adempiere install. 
		 -->
		<mkdir dir="${patch.dir}"/>
		<mkdir dir="${patch.dir}/Adempiere"/>

		<!-- Utils Directory		-->
		<mkdir dir="${patch.dir}/Adempiere/utils"/>
		<copy todir="${patch.dir}/Adempiere/utils">
		  <fileset dir="${base.dir}/utils">
			<include name="windows/Adempiere_Service_Install_64.bat" />
			<include name="windows/Adempiere_Service_Uninstall_64.bat" />
	  	  </fileset>
		</copy>
	  	
		<!-- Migration Directory			-->
	  	<!-- Doesn't hurt to take all contents of the dist directory -->
	  	<mkdir dir="${patch.dir}/Adempiere/migration"/>
		<copy todir="${patch.dir}/Adempiere/migration">
		  <fileset dir="${base.dir}/migration/dist">
		    <include name="**/*.xml"/>
		    <include name="**/*.sql"/>
		  </fileset>
		</copy>
	  	
		<!-- JBoss Directory		-->
		<mkdir dir="${patch.dir}/Adempiere/jboss"/>
		<copy todir="${patch.dir}/Adempiere/jboss/">
		  <fileset dir="${base.dir}/jboss">
			<include name="bin/README-service.txt" />
			<include name="bin/jbosssvc.exe" />
			<include name="bin/jbossweb.x64.exe" />
			<include name="bin/jbosswebw.x64.exe" />
			<include name="bin/native/openssl.exe" />
			<include name="bin/native/tcnative-1.dll" />
			<include name="bin/service.bat" />
			<include name="server/adempiere/deploy/jboss-web.deployer/serverTemplate.xml" />
		  </fileset>
		</copy>
	  	
		<!-- zkwebui Directory		-->
		<mkdir dir="${patch.dir}/Adempiere/zkwebui"/>
		<copy todir="${patch.dir}/Adempiere/zkwebui/">
		  <fileset dir="${base.dir}/zkwebui">
			<include name="images/AD10030HB.png"/>
		  	<include name="theme/default/images/login-logo.png"/>
		  </fileset>
		</copy>

		<!-- Create Patch Install ZIP		-->
	  	<!-- This archive should be extracted over ADEMPIERE_HOME -->
	  	<!-- It includes all patches and associated files. -->
		<zip zipfile="${patch.dir}/${patch.name}.zip"
		   basedir="${patch.dir}"
		   includes="Adempiere/**" />

		<!-- Create Install TAR		-->
	  	<tar longfile="gnu" tarfile="${patch.dir}/${patch.name}.tar.gz"
		  	compression="gzip" >
	  		<tarfileset dir="${patch.dir}" includes="Adempiere/**" excludes="Adempiere/**/*.sh" >
	  		    </tarfileset>
	  		<!-- <tarfileset dir="${patch.dir}" includes="Adempiere/**/*.sh" filemode="755"> -->
	  		<tarfileset dir="${patch.dir}" includes="Adempiere/**/*.sh">
	  		   </tarfileset>
		</tar>  	

		<!-- Create Checksums		-->
	  	
	  	<checksum file="${patch.dir}/${patch.name}.tar.gz"/>
	  	<sleep milliseconds="2000"/>
	  	<loadfile property="myfile" srcFile="${patch.dir}/${patch.name}.tar.gz.MD5">
	  	     <filterchain>
	  	        <striplinebreaks/>
	  	      </filterchain>       
	  	 </loadfile>  		
	  	 <concat destfile="${patch.dir}/${patch.name}.tar.gz.MD5">${myfile} ${patch.name}.tar.gz</concat>
	  		<!-- Test with md5sum -c Adempiere_251.zip.MD5	-->
	  		<checksum file="${patch.dir}/${patch.name}.zip"/>
	  	<sleep milliseconds="2000"/>
	  	  	<loadfile property="myfile2" srcFile="${patch.dir}/${patch.name}.zip.MD5">
	  	  	    <filterchain>
	  	  	        <striplinebreaks/>
	  	  	   </filterchain>  	  	       
	  	  	 </loadfile>  	
	  		<concat destfile="${patch.dir}/${patch.name}.zip.MD5">${myfile2} ${patch.name}.zip</concat>

	  </target>

	
	<!-- ================================================ -->
	<!-- Adempiere Local Install                           -->
	<!-- ================================================ -->
	<target name="install" depends="">
		<echo message="=========== Install Adempiere Patches"/>
		<copy todir="${env.ADEMPIERE_INSTALL}" verbose="true">
			<fileset dir="install/patch" includes="${patch.name}.*" />
		</copy>
		<!-- Delete Existing stuff, but not utils + data 	-->
		<delete failonerror="false" includeEmptyDirs="true">
			<fileset dir="${env.ADEMPIERE_HOME}/migration" includes="**/*" />
			<fileset dir="${env.ADEMPIERE_HOME}/lib"/>
			<fileset dir="${env.ADEMPIERE_HOME}/jboss"/>
		</delete>
		
		<condition property="isWindows">
			<os family="windows" />
		</condition>

		<antcall target="installWin"></antcall>
		<antcall target="installNonWin"></antcall>
		
		<echo message="Install of the patch was completed.  Execute RUN_Setup or RUN_SilentSetup"/>
		<echo message="and then RUN_MigrateXML if new migrations are included in the patch."/>
		
	</target>

	<target name="installWin" description="Environment dependent" if="isWindows">
		<!-- Unzip Install File			-->
		<unzip src="install/patch/${patch.name}.zip" 
			dest="${env.ADEMPIERE_ROOT}" 
			overwrite="yes"/>
	</target>

	<target name="installNonWin" description="Environment dependent" unless="isWindows">
		<!-- Untar Install File			-->
		<gunzip src="install/patch/${patch.name}.tar.gz" 
			dest="${env.ADEMPIERE_ROOT}" /> 
	</target>

	<!-- ================================================ -->
	<!-- complete                                         -->
	<!-- ================================================ -->
	<target name="complete" depends="dist, install">
	</target>

</project>
