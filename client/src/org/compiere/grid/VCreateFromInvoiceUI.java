/******************************************************************************
 * Copyright (C) 2009 Low Heng Sin                                            *
 * Copyright (C) 2009 Idalica Corporation                                     *
 * This program is free software; you can redistribute it and/or modify it    *
 * under the terms version 2 of the GNU General Public License as published   *
 * by the Free Software Foundation. This program is distributed in the hope   *
 * that it will be useful, but WITHOUT ANY WARRANTY; without even the implied *
 * warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.           *
 * See the GNU General Public License for more details.                       *
 * You should have received a copy of the GNU General Public License along    *
 * with this program; if not, write to the Free Software Foundation, Inc.,    *
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.                     *
 *****************************************************************************/
package org.compiere.grid;

import org.compiere.apps.AEnv;
import org.compiere.grid.ed.VLookup;
import org.compiere.model.GridTab;
import org.compiere.model.MDocType;
import org.compiere.model.MLookup;
import org.compiere.model.MLookupFactory;
import org.compiere.swing.CPanel;
import org.compiere.util.*;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.beans.PropertyChangeEvent;
import java.beans.VetoableChangeListener;
import java.util.ArrayList;
import java.util.Vector;
import java.util.logging.Level;

/*
 * @author	Michael McKay
 * 				<li>release/380 - fix row selection event handling to fire single event per row selection
 */
public class VCreateFromInvoiceUI extends CreateFromInvoice implements ActionListener, VetoableChangeListener
{
    private static final long serialVersionUID = 1L;

    private VCreateFromDialog dialog;

    private char isSOTrx='N';

    public VCreateFromInvoiceUI(GridTab mTab)
    {
        super(mTab);
        log.info(getGridTab().toString());

        dialog = new VCreateFromDialog(this, getGridTab().getWindowNo(), true);

        p_WindowNo = getGridTab().getWindowNo();

        //AB 15-09-2015 Sales=Purchase Changes
        if(mTab.getAD_Tab_ID()==263)
        {
            isSOTrx='Y';
        }

        try
        {
            if (!dynInit())
                return;
            jbInit();

            setInitOK(true);
        }
        catch(Exception e)
        {
            log.log(Level.SEVERE, "", e);
            setInitOK(false);
        }
        AEnv.positionCenterWindow(Env.getWindow(p_WindowNo), dialog);
    }   //  VCreateFrom

    /** Window No               */
    private int p_WindowNo;

    /**	Logger			*/
    private CLogger log = CLogger.getCLogger(getClass());

    //
    private JLabel bPartnerLabel = new JLabel();
    private VLookup bPartnerField;

    private JLabel orderLabel = new JLabel();
    private JComboBox orderField = new JComboBox();

    private JLabel shipmentLabel = new JLabel();
    private JComboBox shipmentField = new JComboBox();

    /** Label for the rma selection */
    private JLabel rmaLabel = new JLabel();
    /** Combo box for selecting RMA document */
    private JComboBox rmaField = new JComboBox();

    /**
     *  Dynamic Init
     *  @throws Exception if Lookups cannot be initialized
     *  @return true if initialized
     */
    public boolean dynInit() throws Exception
    {
        log.config("");

        super.dynInit();

        dialog.setTitle(getTitle());

        // RMA Selection option should only be available for AP Credit Memo
        Integer docTypeId = (Integer)getGridTab().getValue("C_DocTypeTarget_ID");
        MDocType docType = MDocType.get(Env.getCtx(), docTypeId);
        if (!MDocType.DOCBASETYPE_APCreditMemo.equals(docType.getDocBaseType()))
        {
            rmaLabel.setVisible(false);
            rmaField.setVisible(false);
        }

        initBPartner(true);
        bPartnerField.addVetoableChangeListener(this);

        return true;
    }   //  dynInit

    /**
     *  Static Init.
     *  <pre>
     *  parameterPanel
     *      parameterBankPanel
     *      parameterStdPanel
     *          bPartner/order/invoice/shopment/licator Label/Field
     *  dataPane
     *  southPanel
     *      confirmPanel
     *      statusBar
     *  </pre>
     *  @throws Exception
     */
    private void jbInit() throws Exception
    {
        bPartnerLabel.setText(Msg.getElement(Env.getCtx(), "C_BPartner_ID"));
        //orderLabel.setText(Msg.getElement(Env.getCtx(), "C_Order_ID", false));

        //AB 15-09-2015 Sales=Purchase Changes
        if (isSOTrx=='N')
        {
            orderLabel.setText(Msg.getElement(Env.getCtx(), "C_Order_ID", false));
        }
        else {orderLabel.setText("Sales Order");}

        shipmentLabel.setText(Msg.getElement(Env.getCtx(), "M_InOut_ID", false));
        rmaLabel.setText(Msg.translate(Env.getCtx(), "M_RMA_ID"));

        CPanel parameterPanel = dialog.getParameterPanel();
        parameterPanel.setLayout(new BorderLayout());

        CPanel parameterStdPanel = new CPanel(new GridBagLayout());

        parameterPanel.add(parameterStdPanel, BorderLayout.CENTER);

        parameterStdPanel.add(bPartnerLabel, new GridBagConstraints(0, 0, 1, 1, 0.0, 0.0
                ,GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(5, 5, 5, 5), 0, 0));
        if (bPartnerField != null)
            parameterStdPanel.add(bPartnerField, new GridBagConstraints(1, 0, 1, 1, 0.0, 0.0
                    ,GridBagConstraints.WEST, GridBagConstraints.HORIZONTAL, new Insets(5, 0, 5, 5), 0, 0));

    	/*parameterStdPanel.add(orderLabel, new GridBagConstraints(2, 0, 1, 1, 0.0, 0.0
    			,GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(5, 5, 5, 5), 0, 0));
    	parameterStdPanel.add(orderField,  new GridBagConstraints(3, 0, 1, 1, 0.0, 0.0
    			,GridBagConstraints.WEST, GridBagConstraints.HORIZONTAL, new Insets(5, 0, 5, 5), 0, 0));*/
        parameterStdPanel.add(shipmentLabel, new GridBagConstraints(2, 2, 1, 1, 0.0, 0.0
                ,GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(5, 5, 5, 5), 0, 0));
        parameterStdPanel.add(shipmentField,  new GridBagConstraints(3, 2, 1, 1, 0.0, 0.0
                ,GridBagConstraints.WEST, GridBagConstraints.HORIZONTAL, new Insets(5, 0, 5, 5), 0, 0));
        // Add RMA document selection to panel
        parameterStdPanel.add(rmaLabel, new GridBagConstraints(2, 3, 1, 1, 0.0, 0.0
                ,GridBagConstraints.EAST, GridBagConstraints.NONE, new Insets(5, 5, 5, 5), 0, 0));
        parameterStdPanel.add(rmaField,  new GridBagConstraints(3, 3, 1, 1, 0.0, 0.0
                ,GridBagConstraints.WEST, GridBagConstraints.HORIZONTAL, new Insets(5, 0, 5, 5), 0, 0));
    }   //  jbInit

    /*************************************************************************/

    private boolean 	m_actionActive = false;

    /**
     *  Action Listener
     *  @param e event
     */
    public void actionPerformed(ActionEvent e)
    {
        log.config("Action=" + e.getActionCommand());

        if (m_actionActive)
            return;
        m_actionActive = true;
        log.config("Action=" + e.getActionCommand());
        //  Order
        if (e.getSource().equals(orderField))
        {
            KeyNamePair pp = (KeyNamePair)orderField.getSelectedItem();
            int C_Order_ID = 0;
            if (pp != null)
                C_Order_ID = pp.getKey();
            //  set Invoice, RMA and Shipment to Null
            rmaField.setSelectedIndex(-1);
            shipmentField.setSelectedIndex(-1);
            loadOrder(C_Order_ID, true);
        }
        //  Shipment
        else if (e.getSource().equals(shipmentField))
        {
            KeyNamePair pp = (KeyNamePair)shipmentField.getSelectedItem();
            int M_InOut_ID = 0;
            if (pp != null)
                M_InOut_ID = pp.getKey();
            //  set Order, RMA and Invoice to Null
            orderField.setSelectedIndex(-1);
            rmaField.setSelectedIndex(-1);
            loadShipment(M_InOut_ID);
        }
        //  RMA
        else if (e.getSource().equals(rmaField))
        {
            KeyNamePair pp = (KeyNamePair)rmaField.getSelectedItem();
            int M_RMA_ID = 0;
            if (pp != null)
                M_RMA_ID = pp.getKey();
            //  set Order and Invoice to Null
            orderField.setSelectedIndex(-1);
            shipmentField.setSelectedIndex(-1);
            loadRMA(M_RMA_ID);
        }
        m_actionActive = false;
    }   //  actionPerformed

    /**
     *  Change Listener
     *  @param e event
     */
    public void vetoableChange (PropertyChangeEvent e)
    {
        log.config(e.getPropertyName() + "=" + e.getNewValue());

        //  BPartner - load Order/Invoice/Shipment
        if (e.getPropertyName().equals("C_BPartner_ID"))
        {
            int C_BPartner_ID = ((Integer)e.getNewValue()).intValue();
            initBPOrderDetails (C_BPartner_ID, true);
        }
        dialog.tableChanged(null);
    }   //  vetoableChange

    /**************************************************************************
     *  Load BPartner Field
     *  @param forInvoice true if Invoices are to be created, false receipts
     *  @throws Exception if Lookups cannot be initialized
     */
    protected void initBPartner (boolean forInvoice) throws Exception
    {
        //  load BPartner
        int AD_Column_ID = 3499;        //  C_Invoice.C_BPartner_ID
        MLookup lookup = MLookupFactory.get (Env.getCtx(), p_WindowNo, 0, AD_Column_ID, DisplayType.Search);
        bPartnerField = new VLookup ("C_BPartner_ID", true, false, true, lookup);
        //
        int C_BPartner_ID = Env.getContextAsInt(Env.getCtx(), p_WindowNo, "C_BPartner_ID");
        bPartnerField.setValue(new Integer(C_BPartner_ID));

        //  initial loading
        initBPOrderDetails(C_BPartner_ID, forInvoice);
    }   //  initBPartner

    /**
     *  Load PBartner dependent Order/Invoice/Shipment Field.
     *  @param C_BPartner_ID BPartner
     *  @param forInvoice for invoice
     */
    protected void initBPOrderDetails (int C_BPartner_ID, boolean forInvoice)
    {
        log.config("C_BPartner_ID=" + C_BPartner_ID);
        KeyNamePair pp = new KeyNamePair(0,"");
        //  load PO Orders - Closed, Completed
        orderField.removeActionListener(this);
        orderField.removeAllItems();
        orderField.addItem(pp);

        ArrayList<KeyNamePair> list = loadOrderData(C_BPartner_ID, forInvoice, false,isSOTrx);
        for(KeyNamePair knp : list)
            orderField.addItem(knp);

        orderField.setSelectedIndex(0);
        orderField.addActionListener(this);
        dialog.pack();

        initBPDetails(C_BPartner_ID);
    }   //  initBPartnerOIS

    public void initBPDetails(int C_BPartner_ID)
    {
        initBPShipmentDetails(C_BPartner_ID);
        initBPRMADetails(C_BPartner_ID);
    }

    /**
     * Load PBartner dependent Order/Invoice/Shipment Field.
     * @param C_BPartner_ID
     */
    private void initBPShipmentDetails(int C_BPartner_ID)
    {
        log.config("C_BPartner_ID" + C_BPartner_ID);

        //  load Shipments (Receipts) - Completed, Closed
        shipmentField.removeActionListener(this);
        shipmentField.removeAllItems();
        //	None
        KeyNamePair pp = new KeyNamePair(0,"");
        shipmentField.addItem(pp);

        //ArrayList<KeyNamePair> list = loadShipmentData(C_BPartner_ID);

        //AB 15-09-2015 Sales=Purchase Changes
        ArrayList<KeyNamePair> list = loadShipmentData(C_BPartner_ID,isSOTrx);

        for(KeyNamePair knp : list)
            shipmentField.addItem(knp);

        shipmentField.setSelectedIndex(0);
        shipmentField.addActionListener(this);
    }

    /**
     * Load RMA that are candidates for shipment
     * @param C_BPartner_ID BPartner
     */
    private void initBPRMADetails(int C_BPartner_ID)
    {
        rmaField.removeActionListener(this);
        rmaField.removeAllItems();
        //  None
        KeyNamePair pp = new KeyNamePair(0,"");
        rmaField.addItem(pp);

        ArrayList<KeyNamePair> list = loadRMAData(C_BPartner_ID);
        for(KeyNamePair knp : list)
            rmaField.addItem(knp);

        rmaField.setSelectedIndex(0);
        rmaField.addActionListener(this);
    }

    /**
     *  Load Data - Order
     *  @param C_Order_ID Order
     *  @param forInvoice true if for invoice vs. delivery qty
     */
    protected void loadOrder (int C_Order_ID, boolean forInvoice)
    {
        loadTableOIS(getOrderData(C_Order_ID, forInvoice));
    }   //  LoadOrder

    protected void loadRMA (int M_RMA_ID)
    {
        loadTableOIS(getRMAData(M_RMA_ID));
    }

    protected void loadShipment (int M_InOut_ID)
    {
        loadTableOIS(getShipmentData(M_InOut_ID));
    }

    /**
     *  Load Order/Invoice/Shipment data into Table
     *  @param data data
     */
    protected void loadTableOIS (Vector<?> data)
    {
        //  Remove previous listeners
        dialog.getMiniTable().removeMiniTableSelectionListener(dialog);
        //  Set Model
        DefaultTableModel model = new DefaultTableModel(data, getOISColumnNames());
        dialog.getMiniTable().setModel(model);
        //
        configureMiniTable(dialog.getMiniTable());
        dialog.getMiniTable().addMiniTableSelectionListener(dialog);
    }   //  loadOrder

    public void showWindow()
    {
        dialog.setVisible(true);
    }

    public void closeWindow()
    {
        dialog.dispose();
    }
}
